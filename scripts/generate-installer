#!/usr/bin/env bash

################################################################################
# Generate a self-contained installer script
#
# This creates a single install-workflow.sh file that includes all the
# necessary files embedded within it. Users can download just this one
# file and run it to install the complete workflow system.
################################################################################

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
OUTPUT_FILE="$PROJECT_ROOT/install-workflow.sh"

cd "$PROJECT_ROOT"

cat > "$OUTPUT_FILE" << 'INSTALLER_HEADER'
#!/usr/bin/env bash
################################################################################
# Claude Code Parallel Workflow System - Self-Contained Installer
#
# This script contains all necessary files embedded within it.
# Simply run it in your project directory to install the workflow system.
#
# Usage:
#   cd /path/to/your-project
#   bash install-workflow.sh
#
# Or download and run:
#   curl -fsSL YOUR_URL/install-workflow.sh | bash
################################################################################

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

info() { echo -e "${BLUE}‚Ñπ${NC} $*"; }
success() { echo -e "${GREEN}‚úì${NC} $*"; }
warning() { echo -e "${YELLOW}‚ö†${NC} $*"; }
error() { echo -e "${RED}‚úó${NC} $*" >&2; }
header() { echo -e "\n${BOLD}${CYAN}$*${NC}\n"; }
die() { error "$*"; exit 1; }

TARGET_DIR="$(pwd)"

header "üöÄ Claude Code Parallel Workflow System - Installer"

echo "Installing in: ${CYAN}$TARGET_DIR${NC}"
echo ""

# Check if ai/ already exists
if [[ -d "$TARGET_DIR/ai" ]]; then
    warning "Directory 'ai/' already exists."
    read -p "$(echo -e ${YELLOW}?${NC} Backup and replace? \(y/N\): )" -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        info "Installation cancelled."
        exit 0
    fi
    BACKUP_NAME="ai.backup.$(date +%Y%m%d_%H%M%S)"
    mv "$TARGET_DIR/ai" "$TARGET_DIR/$BACKUP_NAME"
    success "Backup: $BACKUP_NAME"
fi

info "Extracting files..."

# Function to extract embedded file
extract_file() {
    local filename="$1"
    local start_marker="__FILE_${filename}__"
    local end_marker="__END_${filename}__"

    sed -n "/${start_marker}/,/${end_marker}/p" "$0" | sed '1d;$d'
}

# Function to create file from embedded content
create_file() {
    local filepath="$1"
    local marker="$2"

    mkdir -p "$(dirname "$TARGET_DIR/$filepath")"
    extract_file "$marker" > "$TARGET_DIR/$filepath"

    # Set executable if it's a script
    if [[ "$filepath" =~ ^scripts/ ]] || [[ "$filepath" =~ \.sh$ ]]; then
        chmod +x "$TARGET_DIR/$filepath"
    fi
}

INSTALLER_HEADER

# Now embed all the files
echo "info 'Creating directory structure...'" >> "$OUTPUT_FILE"

# Function to embed a file
embed_file() {
    local filepath="$1"
    local marker="$(echo "$filepath" | sed 's/[\/.]/_/g')"

    echo "create_file '$filepath' '$marker'" >> "$OUTPUT_FILE"
    echo "__FILE_${marker}__" >> "$OUTPUT_FILE"
    cat "$filepath" >> "$OUTPUT_FILE"
    echo "__END_${marker}__" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
}

# Embed all necessary files
echo "Embedding files..."

# Core files
embed_file "README.md"
embed_file "QUICKSTART.md"
embed_file "CHEATSHEET.md"
embed_file "SUMMARY.md"
embed_file ".gitignore"

# AI directory
for file in ai/*.md; do
    [[ -f "$file" ]] && embed_file "$file"
done

for file in ai/workflows/*.yaml ai/workflows/*.md; do
    [[ -f "$file" ]] && embed_file "$file"
done

# Example feature
for file in ai/features/example-todo-api/*; do
    [[ -f "$file" ]] && embed_file "$file"
done

# Scripts
for file in scripts/workflow scripts/workflow-consultant scripts/setup-project; do
    [[ -f "$file" ]] && embed_file "$file"
done

# Hooks
for file in hooks/*; do
    [[ -f "$file" ]] && embed_file "$file"
done

# Add post-installation steps
cat >> "$OUTPUT_FILE" << 'INSTALLER_FOOTER'

success "Files extracted"

# Create project directories
info "Creating project structure..."
mkdir -p "$TARGET_DIR"/{src,frontend,tests,docs}

[[ ! -f "$TARGET_DIR/src/README.md" ]] && cat > "$TARGET_DIR/src/README.md" << 'EOF'
# Source Code
Backend/server source code goes here.
EOF

[[ ! -f "$TARGET_DIR/frontend/README.md" ]] && cat > "$TARGET_DIR/frontend/README.md" << 'EOF'
# Frontend
Frontend/UI source code goes here.
EOF

[[ ! -f "$TARGET_DIR/tests/README.md" ]] && cat > "$TARGET_DIR/tests/README.md" << 'EOF'
# Tests
Test files go here.
EOF

success "Project structure created"

# Install Python dependencies
if command -v pip3 &> /dev/null; then
    info "Installing PyYAML..."
    pip3 install pyyaml --quiet 2>/dev/null || pip3 install --user pyyaml --quiet 2>/dev/null || {
        warning "Could not install PyYAML. Install manually: pip3 install pyyaml"
    }
fi

# Initialize git if needed
if [[ ! -d "$TARGET_DIR/.git" ]]; then
    info "Initializing git..."
    cd "$TARGET_DIR"
    git init
    git add .
    git commit -m "feat: Add Claude Code Parallel Workflow System" 2>/dev/null || true
fi

header "‚úÖ Installation Complete!"

echo ""
echo "üìÅ Installed in: ${CYAN}$TARGET_DIR${NC}"
echo ""
echo "üéØ Quick Start:"
echo ""
echo "  ${CYAN}./scripts/workflow consult${NC}     # Interactive workflow generator"
echo "  ${CYAN}./scripts/workflow status example-todo-api${NC}  # See example"
echo "  ${CYAN}cat QUICKSTART.md${NC}              # 5-minute tutorial"
echo ""
success "Ready to use! üöÄ"
echo ""

exit 0
INSTALLER_FOOTER

chmod +x "$OUTPUT_FILE"

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo ""
echo -e "${GREEN}‚úì${NC} Self-contained installer created: $OUTPUT_FILE"
echo ""
echo -e "${BLUE}‚Ñπ${NC} Users can now install the workflow system with:"
echo ""
echo -e "  ${CYAN}cd /path/to/their-project${NC}"
echo -e "  ${CYAN}bash install-workflow.sh${NC}"
echo ""
echo -e "${BLUE}‚Ñπ${NC} Or distribute it via:"
echo "  - Direct download"
echo "  - curl | bash"
echo "  - Git repository"
echo ""
