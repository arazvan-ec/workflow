name: Risk Policy Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  risk-policy-gate:
    name: Risk Policy Gate
    runs-on: ubuntu-latest

    outputs:
      tier: ${{ steps.gate.outputs.tier }}
      required_checks: ${{ steps.gate.outputs.required_checks }}
      status: ${{ steps.gate.outputs.status }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }} --depth=1

      - name: Run risk policy gate
        id: gate
        run: |
          OUTPUT=$(python3 scripts/risk_policy_gate.py --base origin/${{ github.base_ref }} --json)
          echo "$OUTPUT"

          # Parse JSON output and set step outputs
          TIER=$(echo "$OUTPUT" | python3 -c "import sys,json; print(json.load(sys.stdin)['tier'])")
          STATUS=$(echo "$OUTPUT" | python3 -c "import sys,json; print(json.load(sys.stdin)['status'])")
          CHECKS=$(echo "$OUTPUT" | python3 -c "import sys,json; print(','.join(json.load(sys.stdin)['required_checks']))")

          echo "tier=$TIER" >> "$GITHUB_OUTPUT"
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"
          echo "required_checks=$CHECKS" >> "$GITHUB_OUTPUT"

          # Fail the step if gate didn't pass
          if [ "$STATUS" = "FAIL" ]; then
            echo "::error::Risk policy gate FAILED. See output above for details."
            exit 1
          fi

      - name: Post summary
        if: always()
        run: |
          echo "## Risk Policy Gate" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Status** | ${{ steps.gate.outputs.status }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Risk Tier** | ${{ steps.gate.outputs.tier }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Required Checks** | ${{ steps.gate.outputs.required_checks }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **HEAD SHA** | ${{ github.event.pull_request.head.sha }} |" >> "$GITHUB_STEP_SUMMARY"
