# Multi-Agent Workflow Plugin

A compound engineering framework for coordinating multiple AI agents working in parallel on software development.

---

## ðŸš¨ MANDATORY: Workflow Routing (READ FIRST)

**CRITICAL RULE**: Every interaction with this plugin MUST pass through the workflow router.

### The Golden Rule

> **"No direct workflow execution without routing first. When in doubt, ASK."**

### Mandatory Entry Point

Before executing ANY task, Claude MUST:

1. **Analyze** the user's request
2. **Classify** the type of work (feature, bug, refactor, investigation, etc.)
3. **Assess** complexity and scope
4. **Ask clarifying questions** if confidence is < 60%
5. **Route** to the appropriate workflow

### Quick Routing Command

```bash
/workflows:route
```

### Self-Check Protocol (MUST run before ANY code change)

```markdown
## Router Verification Checklist

- [ ] Did this request pass through /workflows:route?
- [ ] Was the work type clearly identified?
- [ ] Were clarifying questions asked if needed?
- [ ] Is the chosen workflow appropriate for the task?
- [ ] Has trust level been considered for sensitive areas?

âš ï¸ If ANY checkbox is NO â†’ STOP and run /workflows:route first
```

### When to Ask Clarifying Questions

Ask questions when:
- The request is vague or ambiguous
- Multiple workflows could apply
- The scope is unclear
- Sensitive areas (auth, payments, security) may be touched
- The user says "just do it" without specifications

### Clarifying Question Templates

**For Features**:
- Â¿Puedes describir la funcionalidad en 2-3 oraciones?
- Â¿QuiÃ©n usarÃ¡ esta funcionalidad?
- Â¿Backend, frontend, o ambos?
- Â¿Se conecta con APIs externas?
- Â¿Maneja datos sensibles?

**For Bugs**:
- Â¿QuÃ© estÃ¡ pasando ahora vs quÃ© deberÃ­a pasar?
- Â¿CÃ³mo puedo reproducir el error?
- Â¿Siempre ocurre o es intermitente?
- Â¿Hay mensajes de error especÃ­ficos?

**For Refactoring**:
- Â¿QuÃ© archivos/mÃ³dulos estÃ¡n involucrados?
- Â¿Por quÃ© es necesario este cambio?
- Â¿Hay tests existentes?

### Workflow Selection Quick Guide

| User Need | Ask About | Then Route To |
|-----------|-----------|---------------|
| Nueva funcionalidad | Complejidad, stack, integraciones | `/workflows:plan` |
| Bug fix | Reproducibilidad, error messages | `bug-reproducer` â†’ `/workflows:work` |
| Refactoring | Alcance, motivaciÃ³n, tests | Depends on scope |
| InvestigaciÃ³n | QuÃ© necesita saber, dÃ³nde buscar | Research agents |
| Code review | QuÃ© revisar, preocupaciones | `/workflows:review` |

### Exception: Continuing Previous Work

The ONLY exception to mandatory routing is when:
- Continuing an already-routed task in the same session
- The workflow and next steps are already established in `50_state.md`

Even then, verify the context is still valid before proceeding.

---

## Philosophy

> **"Each unit of engineering work should make subsequent units easierâ€”not harder"**
> â€” Compound Engineering Principle

> **"Give it success criteria and watch it go"**
> â€” Karpathy-inspired AI collaboration principle

This plugin extends compound engineering with:

1. **Shared Technical Context**: Agents work with predefined rules (DDD, TDD, project conventions)
2. **Parallel Generation**: Code generated by multiple agents coordinated by roles or layers
3. **Quality Compounding**: Each feature captures learnings for future development

## Quick Start

```bash
# Install the plugin
/plugin marketplace add https://github.com/arazvan-ec/workflow
/plugin install multi-agent-workflow

# Plan a feature (80% of compound engineering)
/workflows:plan user-authentication

# Execute with specific mode
/workflows:work --mode=roles --role=backend user-authentication
/workflows:work --mode=layers --layer=domain user-authentication

# Review before merge
/workflows:review user-authentication

# Capture learnings (compound effect)
/workflows:compound user-authentication
```

## Core Workflows (4 Phases)

| Phase | Command | Purpose | Time |
|-------|---------|---------|------|
| **Plan** | `/workflows:plan` | Convert ideas into implementable strategies | 40% |
| **Work** | `/workflows:work` | Execute with worktrees and task management | 40% |
| **Review** | `/workflows:review` | Multi-agent review before merge | 15% |
| **Compound** | `/workflows:compound` | Capture insights for future work | 5% |

## Parallelization Modes

### By Role (Standard)
```
Planner â†’ Backend + Frontend â†’ QA
```
Best for: Full-stack features with separate concerns

### By Layer (DDD)
```
Domain + Application + Infrastructure (parallel)
```
Best for: Complex backend with business logic

### By Stack
```
Backend complete + Frontend complete (parallel)
```
Best for: Independent features or separate teams

## Agent Categories

| Category | Count | Purpose |
|----------|-------|---------|
| **Roles** | 4 | Core development roles (planner, backend, frontend, qa) |
| **Review** | 4 | Quality assurance (security, performance, DDD, code) |
| **Research** | 3 | Codebase analysis (analyzer, git history, dependencies) |
| **Workflow** | 3 | Automation (bug reproducer, spec analyzer, style enforcer) |
| **Design** | 2 | Architecture (API designer, UI verifier) |

## Multi-Agent Commands

### Core Commands

| Command | Description |
|---------|-------------|
| `/workflows:route` | **MANDATORY** - Route requests to appropriate workflow (entry point) |
| `/workflows:role` | Work as a specific role on a feature |
| `/workflows:sync` | Synchronize state between agents |
| `/workflows:status` | View status of all roles |

### Session & Context Commands

| Command | Description |
|---------|-------------|
| `/workflows:reload` | **Hot-reload** skills/agents without losing context |
| `/workflows:snapshot` | Save session state for later restoration |
| `/workflows:restore` | Restore session from a saved snapshot |
| `/workflows:metrics` | Analyze workflow performance and patterns |

### When to Use Session Commands

- **`/workflows:reload`**: After modifying skill/agent definitions, reload without restarting session
- **`/workflows:snapshot`**: Before long breaks, before risky operations, at major checkpoints
- **`/workflows:restore`**: Resume work in new session, recover from context overflow

## Skills

| Skill | Description |
|-------|-------------|
| **Core** | consultant, checkpoint, git-sync |
| **Quality** | test-runner, coverage-checker, lint-fixer |
| **Workflow** | worktree-manager, commit-formatter |
| **Compound** | changelog-generator, layer-validator |
| **Integration** | mcp-connector (connect to external tools via MCP) |
| **SOLID** | workflow-skill-solid-analyzer, workflow-skill-criteria-generator (with `--solid-rigorous`) |

## The 3-Phase Planning Process

```
PHASE 1: UNDERSTAND â†’ Ask questions â†’ Document problem
PHASE 2: SPECS      â†’ Define WHAT (functional requirements)
PHASE 3: SOLUTIONS  â†’ Design HOW (SOLID mandatory constraint)
```

**SOLID is a MANDATORY CONSTRAINT** in Phase 3. Score â‰¥18/25 to proceed, â‰¥22/25 to approve.

```bash
/workflows:plan user-authentication          # Full 3-phase process
/workflow-skill:solid-analyzer --path=src     # SOLID compliance check
/workflow-skill:criteria-generator --feature=my-feature --interview  # Generate specs
```

See `core/solid-pattern-matrix.md` for violationâ†’pattern mapping and `skills/workflow-skill-solid-analyzer.md` for detailed scoring.

## Key Patterns

### Karpathy Principles (CRITICAL - Apply Always)

Four principles to prevent common AI coding failures:

| Principle | Rule | Quick Check |
|-----------|------|-------------|
| **Think Before Coding** | State assumptions, clarify ambiguities | Did I ask before assuming? |
| **Simplicity First** | Implement ONLY what's requested | Can I delete anything? |
| **Surgical Changes** | Touch ONLY essential code | Is every change necessary? |
| **Goal-Driven Execution** | Define testable success criteria | How do I verify completion? |

See `core/docs/KARPATHY_PRINCIPLES.md` for detailed guidance.

### Ralph Wiggum Pattern (Auto-Correction Loop)
```
while tests_failing and iterations < 10:
    fix_code()
    run_tests()
    if passing: checkpoint_complete()

if iterations >= 10:
    mark_blocked()
    document_for_help()
```

### Compound Capture Pattern
After each feature:
1. Review commits and PRs
2. Identify patterns/anti-patterns
3. Update project rules automatically
4. Document in compound_log.md

### Context Management (Commodore 64)
- Treat context as limited resource
- Checkpoint frequently for session resumption
- Signal to restart: >20 files, >2 hours, >50 messages

## Context Engineering (Fowler Principles)

> *"Curating what the model sees so that you get a better result"* â€” Martin Fowler

### Context Activation Model

| Content Type | Activation | When Loaded |
|---|---|---|
| **Critical rules** (this file) | Always | Every session |
| **Role definitions** (`core/roles/`) | LLM-determined | When role is active |
| **Skills** (`skills/`) | Human-triggered (`/skill:X`) | On invocation |
| **Review agents** (`agents/review/`) | Human-triggered | During `/workflows:review` |
| **Project hooks** (`.ai/hooks/`) | Software-determined | Automatic on tool events |

### Context Isolation (Claude Code 2.1+)

Heavy skills and review agents run with `context: fork` â€” they execute in isolated context windows and return only summaries. This prevents context pollution from large analysis outputs.

**Forked skills**: consultant, token-advisor, coverage-checker, solid-analyzer, spec-merger, changelog-generator, mcp-connector
**Forked agents**: All 7 review agents (security, performance, DDD, code-ts, agent-native, simplicity, pattern-recognition)

### Token Efficiency

- **Search before reading**: `grep` first, then targeted reads
- **Compact proactively**: `/compact` at ~70% capacity
- **One focus per session**: Avoid mixing unrelated features
- **Fork heavy analysis**: Skills with `context: fork` don't consume parent context
- **Use `/skill:token-advisor`** when session feels slow

See `core/docs/SESSION_CONTINUITY.md` for detailed strategies and `core/docs/CONTEXT_ENGINEERING.md` for the full reference on context isolation, portable governance, and the Queen Agent pattern.

## State Management

All roles communicate via `50_state.md`:

```markdown
## Backend Engineer
**Status**: IN_PROGRESS
**Checkpoint**: Domain layer complete
**Notes**: Working on Application layer
```

Status values: `PENDING`, `IN_PROGRESS`, `BLOCKED`, `WAITING_API`, `COMPLETED`, `APPROVED`, `REJECTED`

---

## Lifecycle Hooks (SDK Integration)

The workflow integrates with Claude Code's hook system for **automatic enforcement** and **audit trails**.

### Configured Hooks

| Hook | File | Purpose |
|------|------|---------|
| `PreToolUse` | `.ai/hooks/lifecycle/pre_tool_use.sh` | Trust model enforcement before file edits |
| `PostToolUse` | `.ai/hooks/lifecycle/post_tool_use.sh` | Auto-update `50_state.md`, create audit logs |
| `Stop` | `.ai/hooks/lifecycle/stop.sh` | Auto-checkpoint when agent stops |
| `PreCompact` | `.ai/hooks/lifecycle/pre_compact.sh` | Preserve context before compaction |

### How Hooks Change the Workflow

1. **Automatic Trust Enforcement**: Low-trust files (`auth/`, `security/`, `payment/`) are blocked without pair review - no manual checking needed
2. **State Sync**: `50_state.md` is automatically updated after every tool use
3. **Audit Trail**: All actions logged to `.ai/logs/` for debugging and compliance
4. **Safe Context Compression**: Critical state preserved when context window fills up

### Configuration

Hooks are registered in `.claude/settings.json`. See `core/docs/LIFECYCLE_HOOKS.md` for details.

---

## MCP Integration (External Tools)

Connect to external services via Model Context Protocol (MCP) servers.

### Configured Servers

| Server | Purpose | Used By |
|--------|---------|---------|
| `postgres` | Validate migrations, query DB | backend, qa |
| `github` | Create PRs, read issues | planner, compound |
| `slack` | Notify when BLOCKED | all roles |
| `puppeteer` | Browser automation for UI tests | qa, ui-verifier |

### Using MCP Tools

```bash
# Tools are named: mcp__<server>__<tool>
# Example: mcp__github__create_pull_request

# Use the mcp-connector skill for guided integration
```

### Configuration

MCP servers are configured in `.ai/extensions/mcp/servers.yaml`. See `core/docs/MCP_INTEGRATION.md` for details.

---

## Session Continuity

Manage long-running sessions and context overflow with snapshots.

### Snapshot Workflow

```bash
# Before a break or risky operation
/workflows:snapshot --name="feature-x-checkpoint"

# In a new session, restore context
/workflows:restore --list                    # See available snapshots
/workflows:restore --name="feature-x-checkpoint"
```

### What Gets Saved

- Current `50_state.md` (role status)
- Active tasks from `30_tasks.md`
- Conversation summary
- Modified files list
- Current role and stage

### When to Snapshot

- Before ending a long session
- Before major refactoring
- When context window is filling up (>50 messages)
- Before switching to a different feature

See `core/docs/SESSION_CONTINUITY.md` for details.

---

## Workflow Metrics

Track and analyze workflow performance over time.

### Available Metrics

```bash
/workflows:metrics                    # Overall summary
/workflows:metrics --feature=auth     # Specific feature
/workflows:metrics --role=backend     # Specific role
/workflows:metrics --period=30d       # Time period
```

### What's Tracked

| Metric | Description |
|--------|-------------|
| Stage Duration | Time spent in each workflow stage |
| Checkpoint Pass Rate | % of checkpoints passed on first try |
| Iteration Count | Ralph Wiggum pattern iterations needed |
| Block Frequency | How often roles get BLOCKED |
| Compound Effectiveness | Patterns reused across features |

### Using Metrics

1. Identify slow stages â†’ optimize planning
2. High iteration counts â†’ improve specs
3. Frequent blocks â†’ add documentation
4. Low reuse â†’ capture more patterns

See `core/docs/METRICS.md` for details.

---

## Project Structure

**Immutable** (DO NOT MODIFY): `plugins/multi-agent-workflow/core/`, `plugins/multi-agent-workflow/agents/`, `commands/`, `skills/`
**Customizable**: `.ai/project/`, `.ai/hooks/`, `.ai/extensions/`, `.ai/snapshots/`

| Component | Location | Modifiable |
|-----------|----------|------------|
| Framework Rules | `plugins/.../core/rules/` | NO |
| Project Rules | `.ai/extensions/rules/` | YES |
| Base Roles | `plugins/.../core/roles/` | NO |
| Features & State | `.ai/project/features/` | YES |
| Lifecycle Hooks | `.ai/hooks/lifecycle/` | YES |
| MCP Servers | `.ai/extensions/mcp/` | YES |
| Trust Model | `.ai/extensions/trust/` | YES |

See `README.md` for full directory structure details.

## Best Practices

### Core Practices
1. **Route First, Always**: Every request passes through `/workflows:route` before any work
2. **Ask When Unclear**: If confidence < 60%, ask clarifying questions before proceeding
3. **State Assumptions**: Before coding, explicitly list what you're assuming (Karpathy)
4. **Define Success Criteria**: Transform vague requests into testable goals (Karpathy)
5. **Simplicity First**: Implement ONLY what's requested, avoid over-engineering (Karpathy)
6. **Surgical Changes**: Touch only essential code, preserve existing style (Karpathy)
7. **80% Planning, 20% Execution**: Invest in planning with `/workflows:plan`
8. **One role per session**: Don't switch roles mid-conversation
9. **Sync before work**: Always pull latest changes first
10. **TDD always**: Write tests before implementation
11. **Compound always**: Run `/workflows:compound` after each feature

### Session Management
12. **Snapshot before breaks**: Run `/workflows:snapshot` before ending long sessions
13. **Snapshot before risk**: Create checkpoint before major refactoring or risky changes
14. **Reload after edits**: Use `/workflows:reload` after modifying skills/agents
15. **Review metrics weekly**: Check `/workflows:metrics` to identify bottlenecks

### Hooks & Automation
16. **Trust the hooks**: Lifecycle hooks enforce trust model automatically - don't bypass
17. **Check audit logs**: Review `.ai/logs/` when debugging unexpected behavior
18. **Don't skip hooks**: Avoid `SKIP_HOOKS=true` except in emergencies

## Integration

This plugin works best with:
- **Git**: For synchronization between agents
- **Tilix/tmux**: For running multiple roles in parallel
- **Symfony/React**: Optimized for this stack (but adaptable)
- **DDD Architecture**: Domain-Driven Design patterns
- **Claude Code SDK**: Lifecycle hooks for automation (PreToolUse, PostToolUse, Stop, PreCompact)
- **MCP Servers**: External tool integration (postgres, github, slack, puppeteer)

---

**Version**: 2.4.0
**Aligned with**: Compound Engineering + Karpathy Principles + Claude Agent SDK + Context Engineering (Fowler)
**Last updated**: 2026-02-05
**Inspired by**: [EveryInc/compound-engineering-plugin](https://github.com/EveryInc/compound-engineering-plugin), [Fowler: Context Engineering for Coding Agents](https://martinfowler.com/articles/exploring-gen-ai/context-engineering-coding-agents.html), [Hightower: Build Agent Skills Faster](https://medium.com/@richardhightower/build-agent-skills-faster-with-claude-code-2-1-release-6d821d5b8179)

**v2.4.0 Changes** (Context Engineering & Claude Code 2.1+ Integration):
- Added `context: fork` to all heavy skills (consultant, token-advisor, coverage-checker, solid-analyzer, spec-merger, changelog-generator, mcp-connector) for context isolation
- Added `context: fork` to all 7 review agents for isolated analysis without context pollution
- Added scoped lifecycle hooks in YAML frontmatter to 13 skills/agents (layer-validator, test-runner, checkpoint, lint-fixer, commit-formatter, git-sync, worktree-manager, security-review, performance-review, ddd-compliance, code-review-ts, coverage-checker, mcp-connector)
- Added Queen Agent pattern to `/workflows:route` with forked sub-agent parallel analysis
- Added `/workflows:skill-dev` command for hot-reload skill development workflow
- Calibrated CLAUDE.md context loading: moved detailed catalogs to reference files, added Context Engineering section based on Fowler's activation model
- Added YAML frontmatter to all skills and agents that were missing it
- Reduced CLAUDE.md from ~700 to ~500 lines (context efficiency)
- Updated from 24 to 25 workflow commands

**v2.3.0 Changes**:
- Added 3 new review agents: `agent-native-reviewer`, `code-simplicity-reviewer`, `pattern-recognition-specialist`
- Added 2 new research agents: `learnings-researcher`, `best-practices-researcher`
- Added `/workflows:deepen-plan` command for parallel plan enhancement
- Added `/workflows:heal-skill` command for fixing skill documentation
- Enhanced `/workflows:compound` with parallel subagents for efficient documentation
- Added institutional knowledge structure (`docs/solutions/`) with YAML frontmatter
- Updated from 16 to 21 specialized agents
- Updated from 21 to 24 workflow commands

**v2.2.0 Changes**:
- Integrated Karpathy-inspired coding principles
- Added lifecycle hooks (PreToolUse, PostToolUse, Stop, PreCompact)
- Added MCP server integration, session snapshot/restore, workflow metrics
